name: Demo Workflow

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of test to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - github-script
          - bash
          - mixed
      message:
        description: 'Custom message to display'
        required: false
        default: 'Running demo workflow'
        type: string

permissions:
  contents: read
  actions: read

jobs:
  demo-info:
    name: Demo Information
    runs-on: ubuntu-latest
    steps:
      - name: Display Inputs
        run: |
          echo "=== Demo Workflow Started ==="
          echo "Test Type: ${{ inputs.test_type }}"
          echo "Message: ${{ inputs.message }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Repository: ${{ github.repository }}"

  demo-github-script:
    name: Demo GitHub Script
    runs-on: ubuntu-latest
    if: inputs.test_type == 'all' || inputs.test_type == 'github-script'
    needs: demo-info
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: GitHub Script Demo
        uses: actions/github-script@v7
        with:
          script: |
            console.log('=== GitHub Script Demo ===');
            console.log('Custom message: ${{ inputs.message }}');
            console.log(`Repository: ${context.repo.owner}/${context.repo.repo}`);
            console.log(`Workflow: ${context.workflow}`);
            console.log(`Run ID: ${context.runId}`);
            
            const { data: repo } = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            console.log(`\nRepository Info:`);
            console.log(`  Name: ${repo.name}`);
            console.log(`  Description: ${repo.description || 'No description'}`);
            console.log(`  Stars: ${repo.stargazers_count}`);
            console.log(`  Language: ${repo.language || 'Not specified'}`);
            console.log(`  Created: ${repo.created_at}`);
            console.log(`  Updated: ${repo.updated_at}`);

  demo-bash:
    name: Demo Bash Script
    runs-on: ubuntu-latest
    if: inputs.test_type == 'all' || inputs.test_type == 'bash'
    needs: demo-info
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Bash Script Demo
        run: |
          echo "=== Bash Script Demo ==="
          echo "Custom message: ${{ inputs.message }}"
          echo ""
          
          echo "System Information:"
          echo "  OS: $(uname -s)"
          echo "  Kernel: $(uname -r)"
          echo "  Date: $(date)"
          echo ""
          
          echo "Repository Files:"
          ls -1 | head -10
          echo ""
          
          echo "Test Script Output:"
          ./scripts/test-script.sh demo

  demo-mixed:
    name: Demo Mixed Operations
    runs-on: ubuntu-latest
    if: inputs.test_type == 'all' || inputs.test_type == 'mixed'
    needs: demo-info
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Step 1 - Bash Preparation
        run: |
          echo "=== Step 1: Bash Preparation ==="
          echo "Message: ${{ inputs.message }}"
          
          mkdir -p /tmp/demo
          
          # Create JSON safely with jq to handle special characters
          jq -n \
            --arg workflow "demo" \
            --arg type "${{ inputs.test_type }}" \
            --arg message "${{ inputs.message }}" \
            --arg actor "${{ github.actor }}" \
            --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            '{
              workflow: $workflow,
              type: $type,
              message: $message,
              actor: $actor,
              timestamp: $timestamp
            }' > /tmp/demo/data.json
          
          echo "Created data file:"
          cat /tmp/demo/data.json

      - name: Step 2 - GitHub Script Processing
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            console.log('=== Step 2: GitHub Script Processing ===');
            
            const data = JSON.parse(fs.readFileSync('/tmp/demo/data.json', 'utf8'));
            console.log('Received data:');
            console.log(JSON.stringify(data, null, 2));
            
            const { data: workflows } = await github.rest.actions.listRepoWorkflows({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            console.log(`\nFound ${workflows.total_count} workflows in repository:`);
            workflows.workflows.forEach(wf => {
              console.log(`  - ${wf.name} (${wf.path})`);
            });
            
            data.repo_workflow_count = workflows.total_count;
            fs.writeFileSync('/tmp/demo/enhanced-data.json', JSON.stringify(data, null, 2));
            console.log('\nEnhanced data saved');

      - name: Step 3 - Bash Verification
        run: |
          echo "=== Step 3: Bash Verification ==="
          
          if [ -f /tmp/demo/enhanced-data.json ]; then
            echo "✓ Enhanced data file exists"
            echo ""
            echo "Final data:"
            cat /tmp/demo/enhanced-data.json
            
            echo ""
            echo "Workflow count:"
            jq -r '.repo_workflow_count' /tmp/demo/enhanced-data.json
          else
            echo "✗ Enhanced data file not found"
            exit 1
          fi

  demo-summary:
    name: Demo Summary
    runs-on: ubuntu-latest
    needs: [demo-github-script, demo-bash, demo-mixed]
    if: always()
    steps:
      - name: Display Summary
        uses: actions/github-script@v7
        with:
          script: |
            console.log('=== Demo Workflow Summary ===');
            console.log('Test type: ${{ inputs.test_type }}');
            console.log('Custom message: ${{ inputs.message }}');
            console.log(`Triggered by: ${context.actor}`);
            console.log(`Run ID: ${context.runId}`);
            
            const jobs = {
              'demo-github-script': '${{ needs.demo-github-script.result }}',
              'demo-bash': '${{ needs.demo-bash.result }}',
              'demo-mixed': '${{ needs.demo-mixed.result }}'
            };
            
            console.log('\nJob Results:');
            for (const [job, result] of Object.entries(jobs)) {
              if (result) {
                const icon = result === 'success' ? '✓' : '✗';
                console.log(`  ${icon} ${job}: ${result}`);
              }
            }
            
            console.log('\nDemo workflow completed!');
